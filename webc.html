<!DOCTYPE html>
<head>
    <style>
        table, td, th {
            border: 1px solid black;
            border-collapse: collapse;
        }

        td, th {
            padding: 4px;
        }

        table div {
            background: white;
            width: 1em;
            height: 1em;
            border: 1px solid lightgray;
            border-radius: 0.2em;
        }

        .active {
            background: springgreen;
        }

    </style>
    <script>
        class Bitfield extends HTMLElement {

            constructor()
            {
                super();
                this.fields = [];
            }

            render(bits, value, header)
            {
                let th = header.split(',');
                if (th.length < 3)
                {
                    th = ['Bit', 'Name', 'Value'];
                }

                let html_str = `
                    <table>
                        <tr>
                            <th>${th[0].trim()}</th>
                            <th>${th[1].trim()}</th>
                            <th>${th[2].trim()}</th>
                        </tr>`;

                this.fields = [];
                let idx = 0;

                for (const bit of bits.split(','))
                {
                    const row = bit.trim().split(':');
                    const name = row[0];
                    const len = Number(row[1]) ? Number(row[1]) : 1;
                    this.fields.push(len)
                    const mask = (2**len-1) << idx;
                    const bit_value = (value & mask) >> idx;
                    idx += len;

                    const rowspan_str = len > 1 ? `rowspan="${len}"` : ''

                    html_str += `<tr>
                                    <td><div></div></td>
                                    <td ${rowspan_str}>${name}</td>
                                    <td ${rowspan_str}>${bit_value}</td>
                                 </tr>`;

                    for (let i=1; i<len; i++)
                    {
                        html_str += `<tr><td><div></div></td></tr>`;
                    }
                }

                html_str += '</table>'

                this.innerHTML = html_str;

                this.tbody = this.querySelector('table tbody')
            }

            set value(val)
            {
                this.setAttribute('value', val);
            }

            get value()
            {
                return this.getAttribute('value');
            }

            connectedCallback()
            {
                const value = Number(this.attributes.value.value);
                const bits = this.attributes.bits.value;
                const header = this.hasAttribute('header') ? this.attributes.header.value: 'Bit, Value';

                this.render(bits, value, header);
                this.update_value(value);
            }

            static get observedAttributes()
            {
                return ['value', 'bits'];
            }

            update_value(value)
            {
                let shift = 0;
                for (const [i, len] of this.fields.entries())
                {
                    const mask = (2**len-1) << shift;
                    const bit_value = (value & mask) >> shift;
                    this.tbody.children[shift+1].children[2].textContent = bit_value;

                    for (let i=0; i<len; i++)
                    {
                        if (bit_value & (1 << i))
                        {
                            this.tbody.children[shift+1 + i].children[0].children[0].classList.add('active');
                        }
                        else
                        {
                            this.tbody.children[shift+1 + i].children[0].children[0].classList.remove('active');
                        }
                    }

                    shift += len;
                }
            }
            
            attributeChangedCallback(attrName, oldValue, newValue)
            {
                console.log(attrName);
                if (newValue !== oldValue) {
                    if (attrName == 'value')
                    {
                        this.update_value(newValue);
                    }
                    else if (attrName == 'bits')
                    {
                        const value = Number(this.attributes.value.value);
                        const header = this.hasAttribute('header') ? this.attributes.header.value: 'Bit, Value';
                        this.render(newValue, value, header);
                    }
                }
            }
        }


        class Paramlist extends HTMLElement {

            constructor()
            {
                super();
                this.fields = [];
            }

            render(bits, value, header)
            {
                let th = header.split(',');
                if (th.length < 4)
                {
                    th = ['Param', 'Value', 'New', 'Action'];
                }

                let html_str = `
                    <table>
                        <tr>
                            <th>${th[0].trim()}</th>
                            <th>${th[1].trim()}</th>
                            <th>${th[2].trim()}</th>
                            <th>${th[3].trim()}</th>
                        </tr>`;

                for (const bit of bits.split(','))
                {
                    const name = bit.trim();

                    html_str += `<tr>
                                    <td>${name}</td>
                                    <td>0</td>
                                    <td><input type="number"></td>
                                    <td><button>Set</button></td>
                                </tr>`
                }

                html_str += '</table>'

                this.innerHTML = html_str;

                this.tbody = this.querySelector('table tbody')
            }

            connectedCallback()
            {
                const value = this.attributes.value.value;
                const bits = this.attributes.bits.value;
                const header = this.attributes.header.value;

                this.render(bits, value, header);
            }

            static get observedAttributes()
            {
                return ['value', 'bits'];
            }

            update_value(value)
            {
                let shift = 0;
                for (const [i, len] of this.fields.entries())
                {
                    const mask = (2**len-1) << shift;
                    const bit_value = (value & mask) >> shift;
                    shift += len;
                    this.tbody.children[i+1].children[1].textContent = bit_value;
                }
            }

            set value(val)
            {
                console.log('set value');
                this.setAttribute('value', val);
            }

            get value()
            {
                console.log('get value');
                return this.getAttribute('value');
            }

            attributeChangedCallback(attrName, oldValue, newValue)
            {
                console.log(attrName);
                if (newValue !== oldValue) {
                    if (attrName == 'value')
                    {
                        this.update_value(newValue);
                    }
                    else if (attrName == 'bits')
                    {
                        const value = Number(this.attributes.value.value);
                        const header = this.attributes.header.value;
                        this.render(newValue, value, header);
                    }
                }
            }
        }

        window.customElements.define('pwtk-bitfield', Bitfield);
        window.customElements.define('pwtk-paramlist', Paramlist);
    </script>
</head>
<html>
    <body>
        <h1>Web component testing ground</h1>
        <pwtk-bitfield id='bf-id' bits='A, B:2, C, D, E, F:2' header='Name, Value' value='0x55'></pwtk-bitfield>
        <hr>
        <pwtk-paramlist id='bf-id' bits='A, B, C, D' header='Param, Value' value='1, 2, 3, 4'></pwtk-bitfield>
        <hr>
        <table>
            <tr>
                <th>A</th>
                <th>B</th>
            </tr>
            <tr>
                <td rowspan="3">1</td>
                <td>2</td>
            </tr>
            <tr>
                <td>3</td>
            </tr>
            <tr>
                <td>4</td>
            </tr>
        </table>
    </body>
</html>