<!DOCTYPE html>
<head>
    <script>
        class BoxGauge extends HTMLElement {

            constructor()
            {
                super();
                this.pointer = null;
            }

            render(min, max, nom_min, nom_max, width, height, value)
            {
                if ((min > max) || (nom_min < min) || (nom_min > max) || (nom_max < min) || (nom_max > max) || (nom_min > nom_max))
                {
                    console.log('Box gauge attribute error!');
                    return;
                }

                const scale = width / (max - min);
                const offset = min * scale - 1;

                this.scale = scale;
                this.offset = offset;

                const nom_min_s = nom_min * scale - offset;
                const nom_max_s = nom_max * scale - offset;
                const nom_width = nom_max_s - nom_min_s;
                const value_s = value * scale - offset;

                this.innerHTML =
                    `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                        <title>0</title>
                        <circle cx="${nom_min_s}" cy="${height / 2}" class="pwtk-box-gauge-nom-range"/>
                        <circle cx="${nom_max_s}" cy="${height / 2}" class="pwtk-box-gauge-nom-range"/>
                        <line x1="${nom_min_s}" y1="${height / 2}" x2="${nom_max_s}" y2="${height / 2}" class="pwtk-box-gauge-nom-range"/>
                        <g transform="translate(${value_s})">
                            <line x1="1" y1="1" x2="1" y2="${height-1}" class="pwtk-box-gauge-pointer-hl"/>
                            <line x1="1" y1="1" x2="1" y2="${height-1}" class="pwtk-box-gauge-pointer"/>
                        </g>
                        <path d="M 4 1 L 1 1 L 1 ${height-1} L 4 ${height-1} M ${width-4} 1 L ${width-1} 1 L ${width-1} ${height-1} L ${width-4} ${height-1}" class="pwtk-box-gauge-border"/>
                    </svg>`

                this.pointer = this.querySelector('g');
                this.pointer_shadow = this.querySelectorAll('g line')[0];
            }

            update_value(new_value)
            {
                if (this.pointer)
                {
                    const value_s = new_value * this.scale - this.offset;
                    this.pointer.setAttribute('transform', `translate(${value_s})`)

                    if ((new_value < this.getAttribute('nom_min')) || (new_value > this.getAttribute('nom_max')))
                    {
                        this.pointer_shadow.classList.add('pwtk-box-gauge-pointer-hl-warn');
                    }
                    else
                    {
                        this.pointer_shadow.classList.remove('pwtk-box-gauge-pointer-hl-warn');
                    }

                    this.querySelector('title').textContent = new_value;
                }
            }

            get value()
            {
                return this.getAttribute('value');
            }

            set value(val)
            {
                this.setAttribute('value', val);
            }

            static get observedAttributes()
            {
                return ['value'];
            }
            
            attributeChangedCallback(attrName, oldValue, newValue)
            {
                if (newValue !== oldValue) {
                    if (attrName == 'value')
                    {
                        this.update_value(newValue);
                    }
                }
            }

            connectedCallback()
            {
                const min = this.getAttribute('min');
                const max = this.getAttribute('max');
                const nom_min = this.getAttribute('nom_min');
                const nom_max = this.getAttribute('nom_max');
                const width = this.hasAttribute('width') ? this.getAttribute('width') : 150;
                const height = this.hasAttribute('height') ? this.getAttribute('height') : 10;
                const value = this.getAttribute('value');

                this.render(min, max, nom_min, nom_max, width, height, value);
            }
        }

        window.customElements.define('pwtk-box-gauge', BoxGauge);
    </script>


    <style>
        .pwtk-box-gauge-border {
            fill: none;
            stroke: black;
            stroke-width: 0.8;
            shape-rendering: crispedges;
            opacity: 0.5;
        }

        .pwtk-box-gauge-nom-range {
            stroke: black;
            stroke-width: 0.5;
            opacity: 0.3;
            r: 2;
        }

        .pwtk-box-gauge-pointer {
            stroke: black;
            stroke-width: 2;
            shape-rendering: crispedges;
        }

        .pwtk-box-gauge-pointer-hl {
            stroke: green;
            stroke-width: 6;
            opacity: 0.5;
        }

        .pwtk-box-gauge-pointer-hl-warn {
            stroke: red;
        }

    </style>
</head>
<html>
    <body>
        <h1>Web component testing ground</h1>

        <div id='container'>
            <pwtk-box-gauge id='bg' min='0' max='24' nom_min='10' nom_max='14' value='11.9' width="150" height="15"></pwtk-box-gauge>
        </div>
        <hr>

        <div>
        <svg width="100" height="15" viewBox="0 -7 100 14" xmlns="http://www.w3.org/2000/svg">
            <circle cx="30" cy="0" class="pwtk-box-gauge-nom-range"/>
            <circle cx="60" cy="0" class="pwtk-box-gauge-nom-range"/>
            <line x1="30" y1="0" x2="60" y2="0" class="pwtk-box-gauge-nom-range"/>
            <line x1="40" y1="-6" x2="40" y2="6" class="pwtk-box-gauge-pointer-hl"/>
            <line x1="40" y1="-6" x2="40" y2="6" class="pwtk-box-gauge-pointer"/>
            <path d="M 4 -6 L 1 -6 L 1 6 L 4 6 M 96 -6 L 99 -6 L 99 6 L 96 6" class="pwtk-box-gauge-border"/>
        </svg>
    </div>

    </body>
</html>
